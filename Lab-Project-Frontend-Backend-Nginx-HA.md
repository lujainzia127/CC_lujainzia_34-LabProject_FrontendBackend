# üß™ Lab Project ‚Äì Terraform + Ansible: High-Availability Web Infrastructure

**Student:** Lujain Zia (034)  
**Course:** Cloud Computing  
**Instructor:** Sir Waqas Saleem
**Date:** January 15, 2026

---

## üìã Project Overview

This project demonstrates a production-like AWS infrastructure deployment using:
- **Terraform** for Infrastructure as Code (IaC)
- **Ansible Roles** for configuration management
- **Nginx** as a reverse proxy/load balancer
- **Apache HTTPD** backend servers with high availability

### Architecture Components

- **1 Frontend Server** running Nginx (load balancer)
- **3 Backend Servers** running Apache HTTPD
  - 2 Active backends (round-robin load balancing)
  - 1 Backup backend (failover)
- **VPC, Subnet, Internet Gateway** for networking
- **Security Groups** for access control
- **Automated deployment** with single command

---

## üèóÔ∏è Architecture Diagram

```
                    Internet
                        |
                        ‚Üì
                  [Internet Gateway]
                        |
                        ‚Üì
                   [Public Subnet]
                        |
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         |              |              |
    [Frontend]     [Backend-0]    [Backend-1]    [Backend-2]
     (Nginx)        (HTTPD)        (HTTPD)        (HTTPD)
  Load Balancer     Active         Active         Backup
    Port 80         Port 80        Port 80        Port 80
         |              |              |              |
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  Private IP Communication
```

### Load Balancing Behavior

- **Normal Operation:** Requests alternate between Backend-0 and Backend-1
- **Failover:** If both active backends fail, traffic routes to Backend-2 (backup)
- **Health Checks:** Nginx automatically detects backend failures

---

## üìÅ Project Structure

```
CC_lujainzia_34-LabProject_FrontendBackend/
‚îú‚îÄ‚îÄ main.tf                      # Main Terraform configuration
‚îú‚îÄ‚îÄ variables.tf                 # Variable definitions
‚îú‚îÄ‚îÄ locals.tf                    # Local values (your IP)
‚îú‚îÄ‚îÄ outputs.tf                   # Output values
‚îú‚îÄ‚îÄ inventory.tpl                # Ansible inventory template
‚îú‚îÄ‚îÄ .gitignore                   # Git ignore rules
‚îú‚îÄ‚îÄ README.md                    # This file
‚îÇ
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îî‚îÄ‚îÄ subnet/                  # Subnet module (optional)
‚îÇ       ‚îú‚îÄ‚îÄ main.tf
‚îÇ       ‚îú‚îÄ‚îÄ variables.tf
‚îÇ       ‚îî‚îÄ‚îÄ outputs.tf
‚îÇ
‚îî‚îÄ‚îÄ ansible/
    ‚îú‚îÄ‚îÄ ansible.cfg              # Ansible configuration
    ‚îú‚îÄ‚îÄ inventory/
    ‚îÇ   ‚îî‚îÄ‚îÄ hosts                # Generated by Terraform
    ‚îÇ
    ‚îú‚îÄ‚îÄ playbooks/
    ‚îÇ   ‚îî‚îÄ‚îÄ site.yaml            # Main playbook
    ‚îÇ
    ‚îî‚îÄ‚îÄ roles/
        ‚îú‚îÄ‚îÄ backend/             # Backend role
        ‚îÇ   ‚îú‚îÄ‚îÄ tasks/
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.yml     # Install & configure HTTPD
        ‚îÇ   ‚îú‚îÄ‚îÄ handlers/
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.yml     # Service restart handlers
        ‚îÇ   ‚îî‚îÄ‚îÄ templates/
        ‚îÇ       ‚îî‚îÄ‚îÄ backend_index.html.j2  # Custom backend page
        ‚îÇ
        ‚îî‚îÄ‚îÄ frontend/            # Frontend role
            ‚îú‚îÄ‚îÄ tasks/
            ‚îÇ   ‚îî‚îÄ‚îÄ main.yml     # Install & configure Nginx
            ‚îú‚îÄ‚îÄ handlers/
            ‚îÇ   ‚îî‚îÄ‚îÄ main.yml     # Service restart handlers
            ‚îî‚îÄ‚îÄ templates/
                ‚îî‚îÄ‚îÄ nginx_frontend.conf.j2  # Nginx config with upstream
```

---

## üöÄ Quick Start Guide

### Prerequisites

1. **AWS Account** with access credentials
2. **GitHub Codespace** or local Linux environment
3. **Tools installed:**
   - Terraform (>= 1.0)
   - Ansible (>= 2.9)
   - AWS CLI (>= 2.0)
   - Python 3

### Step 1: Clone the Repository

```bash
git clone https://github.com/lujainzia127/CC_lujainzia_34-LabProject_FrontendBackend.git
cd CC_lujainzia_34-LabProject_FrontendBackend
```

### Step 2: Configure AWS Credentials

```bash
aws configure
# Enter your AWS Access Key ID
# Enter your AWS Secret Access Key
# Default region: me-central-1
# Default output format: json
```

### Step 3: Generate SSH Keys (if not already done)

```bash
ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N ""
```

### Step 4: Deploy Everything

```bash
# Initialize Terraform
terraform init

# Preview what will be created
terraform plan

# Deploy infrastructure and configure servers
terraform apply -auto-approve
```

**‚è±Ô∏è Deployment Time:** 5-7 minutes

**What happens during deployment:**
1. ‚úÖ Creates VPC, subnet, internet gateway, route tables
2. ‚úÖ Creates security groups (SSH from your IP, HTTP from anywhere)
3. ‚úÖ Launches 4 EC2 instances (1 frontend + 3 backends)
4. ‚úÖ Generates Ansible inventory with instance IPs
5. ‚úÖ Waits 60 seconds for instances to be ready
6. ‚úÖ Runs Ansible playbooks to configure all servers
7. ‚úÖ Installs Nginx on frontend with load balancer config
8. ‚úÖ Installs Apache HTTPD on all backends with custom pages

---

## üß™ Testing the Deployment

### Test 1: Get Infrastructure Details

```bash
# View all outputs
terraform output

# Get frontend IP
terraform output frontend_public_ip

# Get backend IPs
terraform output backend_public_ips
```

### Test 2: Verify Backend Servers Individually

```bash
# Test each backend directly
curl http://<backend-0-public-ip>
curl http://<backend-1-public-ip>
curl http://<backend-2-public-ip>
```

**Expected Result:** Each backend shows a unique page with:
- Backend hostname (backend1, backend2, backend3)
- Private IP address
- Custom styled HTML page

### Test 3: Test Load Balancer (Normal Operation)

```bash
# Access frontend multiple times
for i in {1..10}; do 
  curl -s http://<frontend-public-ip> | grep "Backend server"
done
```

**Expected Result:** 
- Responses alternate between **backend1** and **backend2**
- Backend-3 (backup) does NOT appear

### Test 4: Test Failover to Backup Server

```bash
# Stop primary backends
ssh -i ~/.ssh/id_ed25519 ec2-user@<backend-0-ip> "sudo systemctl stop httpd"
ssh -i ~/.ssh/id_ed25519 ec2-user@<backend-1-ip> "sudo systemctl stop httpd"

# Now test frontend
curl http://<frontend-public-ip>
```

**Expected Result:**
- All requests now go to **backend-3** (backup server)
- No connection errors or timeouts

### Test 5: Verify in Browser

Open your browser and visit:
```
http://<frontend-public-ip>
```

Refresh the page multiple times and observe the backend responses changing.

---

## üîß Technical Implementation Details

### Terraform Configuration

#### Key Resources Created

1. **VPC & Networking**
   - VPC with CIDR `10.0.0.0/16`
   - Public subnet `10.0.1.0/24`
   - Internet Gateway
   - Route table for internet access

2. **Security Group**
   - SSH (port 22) from your IP only
   - HTTP (port 80) from anywhere
   - All traffic within VPC

3. **EC2 Instances**
   - Amazon Linux 2 AMI
   - Instance type: `t2.micro` (Free Tier eligible)
   - Public IPs assigned automatically

4. **Automation**
   - `local_file` resource generates Ansible inventory
   - `null_resource` with `local-exec` runs Ansible automatically

#### Key Features

- **Dynamic IP Detection:** Uses `data.http.my_ip` to get your public IP
- **Automatic Inventory:** Template generates inventory with instance IPs
- **Idempotent:** Can run `terraform apply` multiple times safely

### Ansible Configuration

#### Backend Role (`ansible/roles/backend/`)

**Tasks:**
- Install `httpd` package
- Enable and start `httpd` service
- Deploy custom HTML page using template

**Template Variables:**
- `ansible_hostname` - Server hostname
- `ansible_default_ipv4.address` - Private IP

**Handler:**
- Restarts httpd when config changes

#### Frontend Role (`ansible/roles/frontend/`)

**Tasks:**
- Install `nginx` package
- Enable and start `nginx` service
- Deploy custom Nginx configuration

**Template Variables:**
- `backend1_private_ip` - First active backend
- `backend2_private_ip` - Second active backend
- `backup_backend_private_ip` - Backup backend

**Nginx Upstream Configuration:**
```nginx
upstream backend_servers {
    server 10.0.1.x:80;        # Backend 1 (active)
    server 10.0.1.y:80;        # Backend 2 (active)
    server 10.0.1.z:80 backup; # Backend 3 (backup)
}
```

**Handler:**
- Restarts nginx when config changes

#### Main Playbook (`ansible/playbooks/site.yaml`)

```yaml
---
- name: Configure backend HTTPD servers
  hosts: backends
  become: true
  roles:
    - backend

- name: Configure frontend Nginx load balancer
  hosts: frontend
  become: true
  roles:
    - frontend
```

---

---

## üßπ Cleanup

To destroy all resources and avoid AWS charges:

```bash
terraform destroy -auto-approve
```

This will:
- Terminate all EC2 instances
- Delete security groups
- Remove VPC and networking components
- Clean up all AWS resources

---

## üêõ Troubleshooting

### Issue: "Ansible role not found"

**Solution:**
```bash
cd ansible
ls -la roles/  # Verify roles exist
ansible-playbook -i inventory/hosts playbooks/site.yaml -vv  # Debug mode
```

### Issue: "Connection timeout to instances"

**Solution:**
- Wait 2-3 minutes after `terraform apply`
- Check security group allows SSH from your IP
- Verify instances are in "running" state: `aws ec2 describe-instances`

### Issue: "Frontend shows Nginx welcome page"

**Solution:**
```bash
# SSH into frontend
ssh -i ~/.ssh/id_ed25519 ec2-user@<frontend-ip>

# Check Nginx config
sudo cat /etc/nginx/nginx.conf | grep upstream

# If upstream is missing, re-run Ansible
cd ansible
ansible-playbook -i inventory/hosts playbooks/site.yaml
```

### Issue: "Backend shows Apache welcome page"

**Solution:**
```bash
# SSH into backend
ssh -i ~/.ssh/id_ed25519 ec2-user@<backend-ip>

# Check index.html
sudo cat /var/www/html/index.html

# If wrong, re-run Ansible
cd ansible
ansible-playbook -i inventory/hosts playbooks/site.yaml
```

---

## üìù Key Learnings

1. **Infrastructure as Code:** Terraform enables reproducible infrastructure
2. **Configuration Management:** Ansible roles provide clean separation of concerns
3. **High Availability:** Backup servers ensure service continuity
4. **Automation:** Single command deploys entire stack
5. **Security:** Proper use of security groups and SSH keys

---

## üîó References

- [Terraform AWS Provider Documentation](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [Ansible Documentation](https://docs.ansible.com/)
- [Nginx Upstream Module](http://nginx.org/en/docs/http/ngx_http_upstream_module.html)
- [AWS EC2 Documentation](https://docs.aws.amazon.com/ec2/)

---

## üìß Contact

**Name:** Lujain Zia  
**Roll Number:** 034  
**Repository:** https://github.com/lujainzia127/CC_lujainzia_34-LabProject_FrontendBackend

---

## ‚ö†Ô∏è Important Notes

1. **AWS Costs:** This project uses t2.micro instances (Free Tier eligible)
2. **Security:** Never commit AWS credentials or private keys to Git
3. **State Files:** `.tfstate` files contain sensitive data - keep them secure
4. **Region:** Using `me-central-1` (Middle East - UAE) - change in `main.tf` if needed
5. **SSH Keys:** Ensure SSH keys exist before running terraform

---

## üìú License

This project is for educational purposes as part of Cloud Computing coursework at Fatima Jinnah Women University.

---

**Last Updated:** January 2026  
**Project Status:** ‚úÖ Complete and Tested


